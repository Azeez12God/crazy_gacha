#!/usr/bin/env bash
set -e

# 1) Extrae DB_* si viene DATABASE_URL
if [ -n "$DATABASE_URL" ]; then
  export DB_HOST=$(echo "$DATABASE_URL" | sed -E 's#.*@([^:/]+):[0-9]+/.*#\1#')
  export DB_PORT=$(echo "$DATABASE_URL" | sed -E 's#.*@[^:/]+:([0-9]+)/.*#\1#')
  export DB_DATABASE=$(echo "$DATABASE_URL" | sed -E 's#.*/([^/]+)$#\1#')
  export DB_USERNAME=$(echo "$DATABASE_URL" | sed -E 's#postgresql?://([^:]+):.*@.*#\1#')
  export DB_PASSWORD=$(echo "$DATABASE_URL" | sed -E 's#postgresql?://[^:]+:([^@]+)@.*#\1#')
fi

# 2) Permisos storage & cache
chown -R sail:sail /var/www/html/storage /var/www/html/bootstrap/cache
chmod -R 775    /var/www/html/storage /var/www/html/bootstrap/cache

# 3) BD limpia + seed
php /var/www/html/artisan migrate:fresh --seed --force

# 4) Validaci√≥n SUPERVISOR_PHP_USER
if [ "$SUPERVISOR_PHP_USER" != "root" ] && [ "$SUPERVISOR_PHP_USER" != "sail" ]; then
  echo "Set SUPERVISOR_PHP_USER to 'sail' or 'root'."; exit 1
fi

# 5) Ajuste UID sail (opcional)
if [ -n "$WWWUSER" ]; then usermod -u "$WWWUSER" sail; fi

# 6) Composer cache
mkdir -p /.composer && chmod -R ugo+rw /.composer

# 7) Prepara logs y pid de Supervisor
mkdir -p /var/log/supervisor /tmp
touch /var/log/supervisor/supervisord.log
chown -R sail:sail /var/log/supervisor /tmp

# 8) Ejecuta comando o supervisord
if [ $# -gt 0 ]; then
  if [ "$SUPERVISOR_PHP_USER" = "root" ]; then
    exec "$@"
  else
    exec gosu sail "$@"
  fi
else
  exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf
fi
